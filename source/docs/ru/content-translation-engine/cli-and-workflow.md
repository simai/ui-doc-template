---
extends: _core._layouts.documentation
section: content
title: 'Движок перевода контента - интерфейс командной строки и рабочий процесс'
description: 'Движок перевода контента - интерфейс командной строки и рабочий процесс'
---

# CLI и рабочий процесс

В этой главе объясняется, как выполнять переводы из командной строки, что происходит шаг за шагом и как кэш делает последующие запуски добавочными.

---

## Необходимые условия
- **Композитор** Установлен и присутствуют депы поставщика.
- **.env** имеет учетные данные Azure Translator:

  ```
  AZURE_KEY=...
  AZURE_REGION=...
  AZURE_ENDPOINT=https://api.cognitive.microsofttranslator.com
  ```
- **Конфигурация** файл (например, `translate.config.php`) (см. *Конфигурация* глава).

---

## Точки входа
### Композиторский сценарий
```json
"scripts": {
  "translate": "php bin/translate"
}
```
Бежать:
```bash
composer translate
```

### `bin/translate`
Рекомендуемая структура:
```php
#!/usr/bin/env php
<?php
$root = dirname(__DIR__);
require $root . '/vendor/autoload.php';
chdir($root);

use App\Helpers\Translate;
exit((new Translate())->run($argv));
```
> Автозагрузка жизней в **Точка входа**; Классы этого не делают `require 'vendor/autoload.php'` себя.

---

## Что происходит, когда вы его запускаете
1. **Ботинок**:груз `.env`читать `translate.config.php` и проект `config.php`.
2. **Сборка среды CommonMark**:устанавливать **Пользовательские теги** для безопасного разбора Markdown.
3. **Источник сканирования**: найти базовое дерево `source/_docs-<target_lang>`.
4. **Планируйте целевые показатели**: для каждого `lang` в `languages`, обеспечить/подготовить `source/_docs-<lang>`.
5. **Сбор строк**:
    - Markdown: проходим AST, собираем **СМС** ноды (блоки кода/встроенный код/теги остаются нетронутыми).
    - Передняя сторона: собираем только ключи, перечисленные в `frontMatter`.
    - Языковые пакеты: зеркало `.lang.php` / `.settings.php`.
6. **Проверка кэша**: нормализовать → хеш → поиск в `temp/translations/translate_<lang>.json`.
7. **Пакетная обработка и дроссельная заслонка**: группировать непереведенные строки (~9k символов в пакет) и отправлять в Azure; Соблюдайте количество символов в минуту с дрожанием.
8. **Применяйте переводы**:заменять **Восходящий по линейным диапазонам** чтобы избежать смещения положений.
9. **Запись вывода**: обновить/создать файлы в разделе `source/_docs-<lang>`.
10. **Сохранение кэша**:обновлять `translate_<lang>.json`, `hash.json`и `.config.json` (местная карта).

---

## Добавочное поведение
- Кэш обеспечивает **идемпотентность**: неизмененные строки пропускаются.
- Повторный запуск команды после небольших правок только переводит **новое/измененное** СМС.
- Кому **Принудительный повторный перевод** определенную строку, удалите ее запись из `temp/translations/translate_<lang>.json` (или удалите файл, чтобы начать все с чистого листа).

---

## Вывод и компоновка кэша
Относительно `main` (корень проекта):
```
source/
  _docs-<target_lang>/   # input (base locale)
  _docs-<lang>/          # outputs per target language

<cache_dir>/translations/
  translate_<lang>.json  # key → translated string
  hash.json              # bookkeeping
  .config.json           # locales map (consumed by Jigsaw beforeBuild)
```

---

## Интеграция сборки пазла
В `bootstrap.php` (доBuild):
- Если`<cache_dir>/translations/.config.json` существует (например, `temp/translations/.config.json`), объединить его в `config('locales')` Таким образом, в файле появляются новые языки **одинаковый** Build Run.

---

## Журналы и коды выхода
- CLI должен выдавать сводные строки для каждого языка (обнаруженные строки, переведенное количество, повторное использование из кэша).
- Ненулевой код выхода указывает на неустранимую ошибку (недействительная конфигурация, ошибка провайдера, проблемы с вводом-выводом).

### Ошибки поставщика (Azure)
- Проверка статуса и тела HTTP; Реализуйте повторные попытки для 429/5xx.
- Если пакет завершается сбоем, инструмент должен сообщить, какой файл или блок вызвал его, и продолжить работу с другими, когда это будет безопасно.

---

## Общие рабочие процессы
### Первый полный проход
```bash
composer translate
```
Создает `_docs-ru`, заполняет кэш и записывает `.config.json`.

### После редактирования содержимого
```bash
composer translate
```
Отправляются только новые/измененные строки; Все остальное поступает из кэша.

### Добавление нового языка
1) Добавьте его в `languages` в `translate.config.php`.
2) Бежать `composer translate`.
3) Пазл подхватывает его через `.config.json` во время сборки.

---

## Советы
- Хранить `cache_dir` в соответствии с траекторией, использованной в `bootstrap.php` для`.config.json`.
- Использование **Абсолютные пути** в конфигурации, чтобы избежать проблем CWD в CI.
- Следите за ограничениями по количеству символов в минутах, если вы редактируете много файлов.

---

## Устранение неполадок
- **Нет новой локали на сайте**:обеспечивать `.config.json` находится под `<cache_dir>/translations/` И бутстреп объединяет его.
- **Сломана разметка**: проверять, заменяются только текстовые узлы; проверьте наличие ручной постобработки, которая может изменить HTML.
- **Переведенные атрибуты**: подтвердите, что вы не переводите внутренние атрибуты тегов; Должны быть собраны только текстовые узлы.
- **Ошибки автозагрузки**:обеспечивать `bin/translate` Требует `vendor/autoload.php` через **Абсолютный путь** и звонки `chdir($root)`.

