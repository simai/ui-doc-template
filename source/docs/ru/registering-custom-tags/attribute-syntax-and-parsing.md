---
extends: _core._layouts.documentation
section: content
title: 'Синтаксис атрибутов и синтаксический анализ'
description: 'Синтаксис атрибутов и синтаксический анализ'
---

# Синтаксис атрибутов и синтаксический анализ

На этой странице показано, как встраиваемые атрибуты в **Открывающая строку тега** разбираются и объединяются, а также как их эффективно использовать.

---

## Краткое резюме
- Поддерживаемые формы на открытой линии:
    - Пары ключ-значение: `key="value"`, `key:'value'`, `key=value`
    - Сокращения: `.class` (добавить к `class`), `#id` (набор `id`)
- Классы объединяются **и дедупликации**; другие ключи переопределяются с помощью **Побеждает последняя запись**.
- Парсинг предполагает, что **Котировки ASCII** (`"'`) и стандартные пробелы. Видеть **Примечания к Юникоду** если в вашем контенте используются умные цитаты/NBSP.

---

## API
### `Attrs::parseOpenLine(?string $attrStr): array`
Анализирует подстроку после `!type` на начальной строке и возвращает ассоциативный массив атрибутов.

**Поведение (текущая реализация):**
1. Обрежьте шнур; возвращать `[]` когда пусто.
2. Инициализируем пустой список классов; набор `$attrs['class']` временно.
3. Соберите все `key=value` Пары с использованием регулярного выражения:
   ```php
   /(\w[\w:-]*)\s*=\s*(?:"([^"]*)"|'([^']*)'|(\S+))/
   ```
    - **Ключ**: буквы/цифры/подчеркивание, то любой из `[\w:-]` (Только ASCII)
    - **Ценность**: двойные кавычки, одинарные кавычки или лексема без кавычек (без пробелов или `"'=<>
`` `)
    - Особый случай: для `key === 'class'` Значения разбиваются пробелами и добавляются в список классов
4. Удалите все совпадающие `key=value` пар из строки.
5. Синтаксический анализ сокращений с помощью:
   ```php
   /([.#])([\w:-]+)/
   ```
    - `.` добавляет в список классов, `#` Задает `id`
6. Если список классов не пустой, установите `$attrs['class']` в **дедупликация** список, объединенный пробелами; в противном случае удалите временный `class` ключ.
7. Возвращать `$attrs`.

> **Заметка:** Текущие регулярные выражения ориентированы на ASCII (нет `u` модификатор). Если вы ожидаете буквы/пробелы/кавычки в Юникоде, см. **Примечания к Юникоду** ниже приведены рекомендуемые улучшения.

### `Attrs::merge(array ...$sets): array`
Объединяет несколько карт атрибутов в новый массив.

- Выполняет итерации слева направо; для **Не-`class`** ключи, более поздние значения переопределяют более ранние.
- Для `class`, разбивает каждое значение на пробелы, объединяет все классы, **дедупликации**и вновь соединяется с одним пробелом.
- Возвращает объединенную карту. (Если классы отсутствуют, `class` опущено.)

**Пример:**
```php
Attrs::merge(
  ['class' => 'a b', 'id' => 'x'],
  ['class' => 'b c', 'data-x' => '42'],
);
// => ['id' => 'x', 'data-x' => '42', 'class' => 'a b c']
```

---

## Примеры
### 1) Значение в кавычках с пробелами
**Открытая линия**
```md
!example class:"mb-4 border" data-x=42
```
**Разобранные аттры**
```php
['data-x' => '42', 'class' => 'mb-4 border']
```

### 2) Стенографии и id
**Открытая линия**
```md
!example .card .shadow #hero
```
**Разобранные аттры**
```php
['id' => 'hero', 'class' => 'card shadow']
```

### 3) Слияние с базовыми атрибутами
**Основа**
```php
['class' => 'example overflow-hidden']
```
**Встроенный**
```php
['class' => 'mb-4 overflow-hidden', 'data-x' => '1']
```
**Результат `Attrs::merge(base, inline)`**
```php
['data-x' => '1', 'class' => 'example overflow-hidden mb-4']
```
> Обратите внимание, как `overflow-hidden` есть **дедупликация**.

### 4) Дубликат id (последние победы)
```php
Attrs::merge(['id' => 'a'], ['id' => 'b']); // ['id' => 'b']
```

---

## Примечания к Юникоду (смарт-кавычки, NBSP, не-ASCII-ключи)
Биржевые регулярные выражения в `Attrs::parseOpenLine()` использовать классы ASCII (например, `\w`) и нет `u` модификатор, который означает:
- "Умные котировки" (`“ ” ‘ ’`) не будет соответствовать указанным ветвям.
- Неразрывные пробелы (NBSP `\xC2\xA0`) не будут рассматриваться как пробелы.
- Ключи с буквами, отличными от ASCII, не совпадают `\w`.

**Руководство по разработке:** Используйте простые ASCII-кавычки и пробелы в начальной строке, например, `class:"a b"`.

**Рекомендуемое улучшение (опционально):**
- Нормализация смарт-котировок/NBSP в ASCII **перед** синтаксический анализ, или
- Переключитесь на регулярные выражения, поддерживающие Unicode (добавьте параметр `u` модификатор и использование `\p{L}`/`\p{N}`), например:

```php
// Pre-normalize
$attrStr = str_replace(["\xC2\xA0", "“", "”", "‘", "’"], [' ', '"', '"', "'", "'"], $attrStr);

// Unicode-aware patterns
if (preg_match_all('/([\p{L}\p{N}_][\p{L}\p{N}_:-]*)\s*=\s*(?:"([^"]*)"|' .
                   "([^']*)" .
                   '|([^\s"\'=<>`]+))/u', $attrStr, $m, PREG_SET_ORDER)) {
    // ...
}
```

> Если вы принимаете версию Юникода, обновите **оба**тем `key=value` и сокращенные шаблоны, и предпочитайте `preg_split('/\s+/u', ...)` при разделении классов.

---

## Безопасность и валидация
- `Attrs` **не убегает** Значения; Экранирование происходит во время рендеринга (`HtmlElement` или ваш пользовательский рендер) — всегда экранируйте любое значение, которое вы конкатенируете вручную.
- Для предотвращения нежелательных атрибутов (например, `onclick`), реализуйте функцию для каждого тега `attrsFilter(array $attrs, array $meta): array` и **Белый список** разрешенные ключи.

---

## Крайние случаи и советы
- Булевы флаги – это **не разбирается**; предпочитать `flag="true"` или отображайте присутствие в `attrsFilter()`.
- Повторяющаяся стенография `#id` — последнее значение выигрывает после `Attrs::merge`.
- Лишний текст после закрывающего маркера игнорируется парсером; атрибуты должны быть в поле **открытие** линия.
- Пустой `class` входные данные отфильтровываются; В результате не будет пробелов в конце.

---

## Анализы, которые вы должны пройти
1. Кавычки/некавычки; пробелы внутри кавычек.
2. Несколько классов с дубликатами ➜ дедупликация.
3. `.class` + `class:"..."` Вместе ➜ предсказуемо слились.
4. `#id` Переопределяет базу `id` дорога `merge()`.
5. (Если включено) Котировки в Юникоде/нормализация NBSP.

---

## Авторская шпаргалка
- Добавьте классы: `.box .rounded` или `class:"box rounded"`
- Идентификатор набора: `#anchor`
- Ключ–значение с пробелами: `title:"Complex value here"`
- Атрибуты данных: `data-x=42 data-name:'Alice'`

