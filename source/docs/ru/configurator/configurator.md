---
extends: _core._layouts.documentation
section: content
title: Конфигуратор
description: Конфигуратор
---

# Конфигуратор

Тем `Configurator` Class — это центральный помощник, используемый для сбора, обработки и организации локализованной структуры документации
для сборок Jigsaw. Он загружает переводы, строит иерархические и плоские меню, хранит данные о заголовках и позволяет
Функции навигации, такие как навигационные цепочки и ссылки «Следующий/Предыдущий».

## Основная цель

!links

- Чтение структур каталогов для каждого языкового стандарта (например, `source/_docs-${lang}`/)

- Разбирать `.lang.php` для локализации

- Создание дерева страниц документации

- Создание плоской структуры для навигации и поиска

- Управление заголовками и деревьями меню

- Предоставление инструментов для навигационной цепочки и навигации по следующим/предыдущим

!endlinks

## Экземпляр

```php 
$configurator = new \App\Helpers\Configurator($locales);
$jigsaw->setConfig('configurator', $configurator);
```

Это делается во время `beforeBuild` Фаза в `bootstrap.php`.

## Использование в config.php

!links

- Предыдущая/следующая навигация    `$page->configurator->getPrevAndNext(...)`
- Панировочные сухари    `$page->configurator->generateBreadCrumbs(...)`
- Перевод    `$page->configurator->getTranslate(...)`

!endlinks

## Свойства

### Связанные с инициализацией

!links

- публичный массив `$locales` Список кодов локали, например, `['en', 'ru']`

- Публичная строка `$locale` Текущая локаль (по умолчанию: 'ru')

!endlinks

### Выходные данные структуры данных

!links

- публичный массив `$paths` Список всех путей к документации

- публичный массив `$settings` Дерево страниц документации по локали

- публичный массив `$menu` Иерархическая структура вложенного меню

- публичный массив `$flattenMenu` Плоский массив страниц с допустимым путем

- публичный массив `$realFlatten` Плоский массив всех пунктов меню/страниц (в том числе без пути)

- публичный массив `$headings` Отображение пути к файлу с извлеченным массивом заголовков

- публичный массив `$translations` Пары ключ-значение, загруженные для каждого языкового стандарта из .lang.php

!endlinks

## Конструктор

```php 
public function __construct($locales)
```

!links

- Получает `Collection` или массив локалей.

- Извлекает ключи локали с помощью `$locales->toArray()`.

- Триггеры:

  `makeSettings()` — сканирует структуру документации

  `makeLocales()` — загружает переводы

!endlinks

## Внутренние соглашения о файлах/папках

!links

- Страницы живут под рубрикой `source/_docs-<locale>/`

- Каждая папка может содержать:

    - `index.md` (главная страница)

    - `<slug>.md` (например, `install.md`)

    - `.settings.php` (метаданные для каждой папки)

    - `.lang.php` (переводы)

!endlinks

## Разбивка методов

> makeLocales(): void

Сканирование каждого языкового стандарта `.lang.php` и загружает данные трансляции ключ-значение в `$translations`.

```php 
$file = 'source/_docs-' . $locale . '/.lang.php';
$this->translations[$locale] = include $file;
```

> makeSettings(): void

Стержневой метод. Выполняет все следующие действия:
!links

- Сканирует файловую систему на наличие `.settings.php`

- Создает рекурсивный объект `$settings[locale]` дерево

- Расплющивает дерево в `realFlatten` и `flattenMenu`

- Создает вложенное меню с помощью `buildMenuTree()`

- Также звонит:

  `makeFlatten()`

  `buildMenuTree()`

!endlinks

> array_set_deep(&$array, $path, $value, $locale): недействительный

Внутренний помощник для глубокого введения `$value` в многоуровневый массив, основанный на разделении косой чертой `$path`.

Используется для структурирования иерархии страниц на основе имен папок.

> makeFlatten(массив $items, строка $locale): массив

Создает плоский список страниц документации из вложенного дерева, вызывая `makeMenu()`.

```php 
return [
'flat' => [
['key' => 'getting-started', 'path' => '/ru/getting-started', 'label' => 'Getting Started'],
...
]
];
```

> makeMenu(массив $items, массив &$pages, строка $prefix, строка $locale)

Рекурсивный метод, используемый `makeFlatten()` для заселения плоской структуры, соблюдая `has_index` и пользовательские меню.

Каждая плоская страница записывается:
!links

- `key` (слаг)

- `path` (URL)

- `label` (название)

!endlinks

> buildMenuTree(массив $items, строка $prefix = '', строка $locale = 'ru'): массив

Создает вложенный ассоциативный массив страниц и дочерних элементов.

Используется для навигации по боковой панели и древовидных меню.

```php
[
    '/ru' => [
        'title' => 'Home',
        'path' => '/ru',
        'children' => [
            '/ru/install' => [...],
        ],
    ],
]
```

> generateBreadCrumbs(строка $locale, массив $segments): массив
***Используется в***: `config.php > generateBreadcrumbs`

Берет сегменты URL и возвращает список элементов из плоской структуры, которые соответствуют этому пути.

Полезно для навигации по странице с помощью навигационной цепочки.

> getPrevAndNext(string $path, string $locale): массив

Использует `$flattenMenu[locale]` , чтобы найти предыдущую и следующую переходные страницы относительно заданной `$path`.

```php 
[
'prev' => [...],
'next' => [...],
]
```

> makeUniqueHeadingId(string $relativePath, string $level, int $index): string

Создает идентификатор заголовка на основе хэша, используемый для уникальной идентификации `h1`–`h4` Заголовки на страницах документации.

Пример вывода: `h-df13a9c218f3`

> setHeading(строка $path, массив $headings): void

Хранит данные о заголовках на каждой странице документации.

```php 
$this->headings['ru/getting-started'] = [
  ['id' => 'intro', 'text' => 'Introduction', 'level' => 'h2']
];
```

> flattenNav(массив $items, массив &$flat): массив

Извлекает все пункты меню из глубоко вложенной структуры и добавляет их в плоский массив.

Вызывается при создании индексированных или перемещаемых представлений содержимого меню.

> getTranslate(строка $text, строка $locale): строка
***Используется в***: `config.php > translate`

Загружает перевод для заданного $text из `.lang.php` Нагружено во время `makeLocales()`.

Если не найдено, возвращает пустую строку ('').

> setLocale(строка $locale): void

Задает рабочую локаль для внутренней логики.

> setPaths(массив $paths): void

Регистрирует пути к документации для ссылок или индексации.

## Использование в жизненном цикле сборки Bootstrap

Тем `Configurator` Класс не только представлен в `config.php`, но также плотно интегрирован в сборку Jigsaw
Жизненный цикл через `bootstrap.php`.

Ниже приведена разбивка того, как и где его методы вызываются в каждом событии жизненного цикла:

### beforeBuild

```php 
$locales = $jigsaw->getConfig('locales');
$configurator = new \App\Helpers\Configurator($locales);
$jigsaw->setConfig('configurator', $configurator);
```

На этом этапе:

- Тем `Configurator` создается

- `.lang.php` и `.settings.php` файлы загружаются

- Он строит:

    - `$configurator->settings`

    - `$menu`, `$flattenMenu`, `$realFlatten`

    - `$translations`

Это гарантирует, что остальная часть процесса сборки и шаблонов может использовать данные навигации, меню и перевода.

### afterCollections

Именно здесь заголовки на уровне страниц и индексация подготавливаются с помощью `Configurator`.

1. ***setЗаголовок***($path, $headings)
   На каждой странице `<h2>`–`<h4>` Теги анализируются и сохраняются в виде метаданных заголовка:

    ```php 
    $configurator->setHeading($page->getPath(), $rightMenuHeadings);
    ```

   Это обеспечивает навигацию по боковой панели или оглавление страниц.

2. ***makeUniqueHeadingId***()

   Пользовательские идентификаторы заголовков генерируются для каждого заголовка, чтобы обеспечить уникальность и согласованность анкорных ссылок:

    ```php 
    $id = $configurator->makeUniqueHeadingId($page->getPath(), $match[1], $key);
    ```
   Также используется, когда в заголовке отсутствует явный `id` атрибут.

3. ***setPaths***(массив $paths)

   Все обработанные пути к страницам собираются и передаются в Конфигуратор, который сохраняет их для потенциального использования в поиске или
   Генерация карты сайта:
    ```php 
    $configurator->setPaths($paths);
    ```

### afterBuild

На этом этапе визуализированный HTML подвергается постобработке. `Configurator` Помогает:

1. Назначение идентификаторов заголовков
   Ещё раз `makeUniqueHeadingId()` гарантирует, что все заголовки в окончательном выводе HTML имеют действительные, согласованные якоря:

    ```php 
    $id = $configurator->makeUniqueHeadingId($relativePath, $tag, $count);
    ```
2. Создание якорных ссылок
   HTML обновляется и включает в себя якорные ссылки (например, `#` icons) с идентификаторами:

    ```html
    <h2 id="h-abc123"><a href="#h-abc123" class="header-anchor">#</a><span>Heading</span></h2>
    ```

## Сводка по использованию Bootstrap

| Фаза | Используемые методы | Цель |
|--------------------|-------------------------------------------------|---------------------------------------------------|
| `beforeBuild`      | `__construct`, `makeSettings`, `makeLocales`    | Инициализация настроек и переводов |
| `afterCollections` | `setHeading`, `makeUniqueHeadingId`, `setPaths` | Хранение данных о заголовках и путях для каждой страницы |
| `afterBuild`       | `makeUniqueHeadingId`                           | 	Убедитесь, что конечные выходные заголовки правильно связаны |

## Поддержка генерации индексов

Кроме того, во время afterCollections для каждой страницы генерируется следующая структура:

```php 
[
  'title' => $title,
  'url' => $page->getUrl(),
  'lang' => $page->language ?? '',
  'content' => trim($cleanedContent),
  'headings' => $headings,
];
```

Он хранится в `$jigsaw->setConfig('INDEXES', $index);` и позже сохранен как `search-index_<lang>.json`.

Эта система опирается на:
!links

- `$configurator->getHeading()`

- `$configurator->getPaths()`

- `$configurator->getItems($locale)`

!endlinks
Несмотря на то, что эти методы не вызываются напрямую в bootstrap, их данные используются в ключевых функциях шаблонов и индексации.

